#!/usr/bin/env bash
# ABOUTME: Install/update selected Piper voices by downloading individual files.
# ABOUTME: Stores voices in nested structure: ~/.local/share/piper/voices/{lang}/{voice_key}/

# shellcheck source=shell-and-scripting-helpers/.qfuncs.sh
source "$(dirname "$0")"/shell-and-scripting-helpers/.qfuncs.sh

set -euo pipefail

dest=~/.local/share/piper/voices
base_url="https://huggingface.co/rhasspy/piper-voices/resolve/main"

voices=(
   # === HIGH QUALITY VOICES - Well regarded for naturalness ===
   "en/en_US/lessac/high/en_US-lessac-high"                                   # US female (high) - Excellent quality, very natural
   "en/en_US/ryan/high/en_US-ryan-high"                                       # US male (high) - Clear, professional
   "en/en_US/ljspeech/high/en_US-ljspeech-high"                              # US female (high) - LJ Speech dataset, very clear
   "en/en_US/libritts_r/medium/en_US-libritts_r-medium"                      # LibriTTS-R, high quality multi-speaker (only medium available)
   "en/en_US/kristin/medium/en_US-kristin-medium"                            # US female (medium) - Warm, natural tone
   "en/en_US/kathleen/low/en_US-kathleen-low"                                # US female (low) - Deep, rich voice
   "en/en_US/danny/low/en_US-danny-low"                                      # US male (low) - Deep, authoritative
   "en/en_US/norman/medium/en_US-norman-medium"                              # US male (medium) - Professional narrator style
   
   # === EXISTING QUALITY VOICES ===
   "en/en_GB/cori/high/en_GB-cori-high"                                       # UK female (high)
   "en/en_GB/alan/medium/en_GB-alan-medium"                                   # UK male (medium)
   "en/en_GB/northern_english_male/medium/en_GB-northern_english_male-medium" # UK male regional (medium)
   "en/en_GB/alba/medium/en_GB-alba-medium"                                   # UK female (medium)
   "en/en_GB/jenny_dioco/medium/en_GB-jenny_dioco-medium"                     # UK female (medium)
   "en/en_GB/vctk/medium/en_GB-vctk-medium"                                   # UK multi-speaker VCTK dataset
   
   # # === ADDITIONAL US VOICES ===
   # "en/en_US/amy/medium/en_US-amy-medium"                                     # US female (medium)
   # "en/en_US/lessac/medium/en_US-lessac-medium"                              # US female (medium)
   # "en/en_US/hfc_male/medium/en_US-hfc_male-medium"                          # US male (medium)
   # "en/en_US/hfc_female/medium/en_US-hfc_female-medium"                      # US female (medium)
   # "en/en_US/joe/medium/en_US-joe-medium"                                     # US male (medium) - Natural conversational
   # "en/en_US/john/medium/en_US-john-medium"                                   # US male (medium) - Clear articulation
   # "en/en_US/bryce/medium/en_US-bryce-medium"                                 # US male (medium) - Smooth delivery
   # "en/en_US/sam/low/en_US-sam-low"                                          # US male (low) - Deep, resonant
   
   # === EXPERIMENTAL/SPECIALTY VOICES ===
   #   "en/en_US/l2arctic/medium/en_US-l2arctic-medium"                      # L2-ARCTIC dataset
   #   "en/en_US/arctic/medium/en_US-arctic-medium"                          # ARCTIC dataset
   #   "en/en_US/libritts/medium/en_US-libritts-medium"                      # LibriTTS original
   #   "en/en_US/kusal/medium/en_US-kusal-medium"                            # Accented English
   #   "en/en_GB/southern_english_female/low/en_GB-southern_english_female-low"
   #   "en/en_GB/aru/medium/en_GB-aru-medium"
   #   "en/en_GB/semaine/medium/en_GB-semaine-medium"
   
   # === OTHER LANGUAGES (Uncomment as needed) ===
   # "nl/nl_BE/nathalie/medium/nl_BE-nathalie-medium"                         # BE Dutch female (medium)
)

mkdir -p "$dest"

# Migrate any existing flat-structure voices to nested structure.
# Old layout: $dest/en_US-lessac-high.onnx
# New layout: $dest/en_US/en_US-lessac-high/en_US-lessac-high.onnx
migrated=()
for flat_file in "$dest"/*.onnx; do
   if [[ -f "$flat_file" ]]; then
      voice_key=$(basename "$flat_file" .onnx)
      lang="${voice_key%%-*}"
      nested_dir="$dest/$lang/$voice_key"
      if [[ ! -d "$nested_dir" ]]; then
         mkdir -p "$nested_dir"
         mv "$flat_file" "$nested_dir/"
         # Move the .onnx.json too if it exists
         if [[ -f "$dest/$voice_key.onnx.json" ]]; then
            mv "$dest/$voice_key.onnx.json" "$nested_dir/"
         fi
         migrated+=("$voice_key")
      fi
   fi
done

if [[ ${#migrated[@]} -gt 0 ]]; then
   info "Migrated ${#migrated[@]} voice(s) to nested directory structure:"
   printf "  • %s\n" "${migrated[@]}" >&2
fi

success=()
fails=()
already=()

for voice in "${voices[@]}"; do
   # Extract the voice key from the path (everything after the last /)
   voice_key=$(basename "$voice")
   # Extract language code (everything before the first dash)
   lang="${voice_key%%-*}"

   voice_dir="$dest/$lang/$voice_key"
   mkdir -p "$voice_dir"

   for ext in onnx onnx.json; do
      source_url="$base_url/$voice.$ext"
      target_path="$voice_dir/$voice_key.$ext"

      if [[ -e "$target_path" ]]; then
         warn "Skipping $voice_key.$ext"
         already+=("$voice_key.$ext")
      else
         info "Downloading $voice_key.$ext ..."
         if command -v curl >/dev/null 2>&1; then
            curl -L --fail -o "$target_path" "$source_url" || {
               errortext "Failed to download $source_url"
               fails+=("$voice_key.$ext")
               continue
            }
         elif command -v wget >/dev/null 2>&1; then
            wget -O "$target_path" "$source_url" || {
               errortext "Failed to download $source_url"
               fails+=("$voice_key.$ext")
               continue
            }
         else
            die "curl or wget required to download voices."
         fi
         if [[ -e "$target_path" ]]; then
            success+=("$voice_key.$ext")
         fi
      fi
   done
done

if [[ ${#success[@]} -gt 0 ]]; then
   checktext "Successfully downloaded:"
   printf "  • %s\n" "${success[@]}" >&2
fi

if [[ ${#fails[@]} -gt 0 ]]; then
   errortext "Failed to download:"
   printf "  • %s\n" "${fails[@]}" >&2
fi

if [[ ${#already[@]} -gt 0 ]]; then
   warn "The following were already installed:"
   printf "  • %s\n" "${already[@]}" >&2
fi

echo "Voices installed under: $dest"
